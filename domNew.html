<!DOCTYPE html>
<html>

<head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="container">
        <ul class="comments" id="comment-list">
            <!-- <li class="comment">
                <div class="comment-header">
                    <div>Глеб Фокин</div>
                    <div class="comment-date">12.02.22 12:18</div>
                </div>
                <div class="comment-body">
                    <div class="comment-text">
                        Это будет первый комментарий на этой странице
                    </div>
                </div>
                <div class="comment-footer">
                    <div class="likes">
                        <span class="likes-counter">3</span>
                        <button class="like-button"></button>
                    </div>
                </div>
            </li>
            <li class="comment">
                <div class="comment-header">
                    <div>Варвара Н.</div>
                    <div>13.02.22 19:22</div>
                </div>
                <div class="comment-body">
                    <div class="comment-text">
                        Мне нравится как оформлена эта страница! ❤️
                    </div>
                </div>
                <div class="comment-footer">
                    <div class="likes">
                        <span class="likes-counter">75</span>
                        <button class="like-button active-like"></button>
                    </div>
                </div>
            </li> -->
        </ul>
        <div class="add-form">
            <input type="text" name="autor" class="add-form-name" placeholder="Введите ваше имя" id="name-input" />
            <textarea type="textarea" name="text" class="add-form-text" placeholder="Введите ваш коментарий" rows="4"
                id="comment-input"></textarea>
            <input type="hidden" name="reply-author" id="reply-author">
            <input type="hidden" name="reply-text" id="reply-text">
            <div class="add-form-row">
                <button class="add-form-button" id="add-comment-button">Написать</button>
            </div>
        </div>
    </div>
    <script>
        'use strict';
        const buttonElement = document.getElementById('add-comment-button');
        const listElement = document.getElementById('comment-list');
        const nameInputElement = document.getElementById('name-input');
        const commentInputElement = document.getElementById('comment-input');

        let isReplay = false;

        const users = [
            {
                name: 'Глеб Фокин',
                time: '12.02.22 12:18',
                comment: 'Это будет первый комментарий на этой странице',
                likesCount: 3,
                isLiked: false,
            },
            {
                name: 'Варвара Н.',
                time: '13.02.22 19:22',
                comment: 'Мне нравится как оформлена эта страница!❤️',
                likesCount: 75,
                isLiked: true,
            },
        ];

        function initLikeButtons() {

            const likeButtons = document.querySelectorAll(".like-button");

            likeButtons.forEach((button) => {
                button.addEventListener("click", (event) => {
                    const userIndex = event.target.dataset.index;
                    const user = users[userIndex];
                    const likeIcon = event.target.querySelector(".like-icon");

                    if (user.isLiked) {
                        user.likesCount--;
                        user.isLiked = false;
                    } else {
                        user.likesCount++;
                        user.isLiked = true;
                    }
                    renderUsers();
                });
            });
        }
        const renderUsers = () => {
            const usersHTML = users.map((user, index) => {
                return `
                <li class="comment">
                    <div class="comment-header" data-comment-id="1">
                    <div>${user.name}</div>
                    <div class="comment-date">${user.time}</div>
                    </div>
                    <div class="comment-body">
                    <div class="comment-text">
                        ${user.comment}
                    </div>
                    </div>
                    <div class="comment-footer">
                    <div class="likes">
                        <span class="likes-counter">${user.likesCount}</span>
                        <button class="like-button ${user.isLiked ? 'active-like' : ''}" data-index='${index}'></button>
                    </div>
                    </div>
                </li>
                `;
            }).join("");

            listElement.innerHTML = usersHTML;
            initLikeButtons();
        };

        renderUsers();

        buttonElement.addEventListener("click", () => {
            if (nameInputElement.value === "" || commentInputElement.value === "") {
                buttonElement.disabled = true;
                return;
            }

            users.push({
                name: nameInputElement.value,
                time: getCurrentDate(new Date()),
                comment: commentInputElement.value,
                likesCount: 0,
                isLiked: false,
            });

            renderUsers();
            nameInputElement.value = "";
            commentInputElement.value = "";
        });



        function getCurrentDate(date) {
            let day = date.getDate();
            if (day < 10) day = '0' + day;
            let month = date.getMonth() + 1;
            if (month < 10) month = '0' + month;
            let hour = date.getHours();
            if (hour < 10) hour = '0' + hour;
            let minute = date.getMinutes();
            if (minute < 10) minute = '0' + minute;
            return day + '.' + month + '.' + (date.getFullYear() % 100) + ' ' + hour + ':' + minute;
        };

        const addComment = () => {
            console.log(isReplay);

            const listElementValue = isReplay
                ? `QUOTE_BEGIN${listElement.value}QUOTE_END`
                : listElement.value;
            if (nameInputElement.value === '') {
                nameInputElement.classList.add('form-error');
                return;
            } else {
                comments.push({
                    name: replaceValue(nameInputElement.value),
                    comment: replaceValue(listElementValue)
                        .replaceAll('QUOTE_BEGIN', '<div class="quote">')
                        .replaceAll('QUOTE_END', '</div>'),
                    time: getCurrentDate(new Date()),
                    likesCount: 0,
                    isLiked: '',
                });
                console.log(comments);
            }
            renderComments();

            listElement.value = '';
            nameInputElement = '';
            listElement.classList.remove('form-error');
            nameInputElement.classList.remove('form-error');
            isReplay = false;
            console.log(isReplay);
        };

        const likeComment = () => {
            const likeButtons = document.querySelectorAll('.like-button');

            for (const likeButton of likeButtons) {
                likeButton.addEventListener('click', (event) => {
                    event.stopPropagation();

                    let index = likeButton.dataset.index;
                    let likesCount = comments[index].likeCount;

                    if (comments[index].activeClass === 'like-button -active-like') {
                        likesCount -= 1;
                        comments[index].activeClass = 'like-button';
                    } else {
                        likesCount += 1;
                        comments[index].activeClass = 'like-button -active-like';
                    }
                    commnets[index].likesCount = likesCount;
                    renderComments();
                });
            }
        };

        const newReplay = () => {
            const commentElements = document.querySelectorAll('.comment');

            for (const commentElement of commentElements) {
                commentElement.addEventListener('click', () => {
                    let index = commentElement.dataset.index;

                    const originalText = `${comments[index].name} : ${comments[index].comment
                        .replaceAll('<div class="quote">', '')
                        .replaceAll('</div>', '')}`;
                    listElement.value = originalText;
                    isReplay = true;
                    console.log(isReplay);
                });
            }
        };

        const replaceValue = (value) => {
            return value
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;');
        };

        renderComments();

        addButton.addEventListener('click', addComment);
        listElement.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                addComment();
            }
        });

        nameInputElement.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                addComment();
            }
        });
        console.log('It works!');



        document.getElementById('add-comment-button').addEventListener('click', (event) => {
            event.preventDefault();
            const author = document.getElementById('name-input').value;
            const text = document.getElementById('comment-input').value;

            if (author.trim() === '' || text.trim() === '') {
                return;
            }
            const newComment = document.createElement('div');
            newComment.classList.add('comment');
            newComment.innerHTML = `<strong>${author}:</strong> ${text}`;
            newComment.dataset.author = author;
            newComment.dataset.text = text;
            document.getElementById('comment-list').appendChild(newComment);

            document.getElementById('name-input').value = '';
            document.getElementById('comment-input').value = '';
        });
    </script>
</body>

</html>